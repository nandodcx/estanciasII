<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Universitario - Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/dash.css">
    <style>
        /* Estilos de carga */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* FIX TEMPORAL PARA HEADER */
        .header-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            height: 64px !important;
            background: white !important;
            border-bottom: 1px solid #e5e7eb !important;
            z-index: 1000 !important;
            display: flex !important;
            align-items: center !important;
        }

        .dark .header-container {
            background: #1f2937 !important;
            border-bottom-color: #374151 !important;
        }

        .header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            width: 100% !important;
            max-width: 100% !important;
            padding: 0 1rem !important;
        }

        .logo-img {
            height: 40px !important;
            width: auto !important;
        }

        .user-initials {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #10b981, #9BD86B) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: white !important;
            font-weight: bold !important;
        }

        body {
            padding-top: 64px !important;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
    
    <!-- Header -->
    <div id="header-container">
        <div class="p-4 text-center text-gray-500">Cargando header...</div>
    </div>

    <div class="flex pt-16">
        <!-- Mobile Sidebar -->
        <div id="mobile-sidebar-container">
            <div class="p-4 text-center text-gray-500">Cargando men√∫ m√≥vil...</div>
        </div>

        <!-- Desktop Sidebar -->
        <div id="desktop-sidebar-container">
            <div class="p-4 text-center text-gray-500">Cargando sidebar...</div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 md:ml-64 mt-0">
            <!-- Views Container -->
            <div id="views-container">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
                    <p class="mt-4 text-gray-600">Cargando Sistema Universitario...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modals-container"></div>

    <!-- Mensaje de √©xito -->
    <div id="success-message" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden fade-in">
        <div class="flex items-center gap-2">
            <i class="fas fa-check-circle"></i>
            <span id="success-text">¬°Operaci√≥n completada exitosamente!</span>
        </div>
    </div>

    <!-- ‚úÖ NUEVO: Cargar dash.js aqu√≠ -->
    <script src="assets/js/dash.js"></script>

    <script>
        // Configuraci√≥n de rutas BASE
        const getBasePath = () => {
            const path = window.location.pathname;
            if (path.includes('estanciasII')) {
                return path.split('estanciasII')[0] + 'estanciasII/';
            }
            return '/';
        };

        const BASE_PATH = getBasePath();
        console.log('Base path:', BASE_PATH);

        // Estado global de la aplicaci√≥n
        const appState = {
            currentView: 'dashboard',
            basePath: BASE_PATH,
            views: {
                'dashboard': `${BASE_PATH}views/dashboard-view.html`,
                'practices': `${BASE_PATH}views/practices-view.html`,
                'agenda': `${BASE_PATH}views/agenda-view.html`,
                'users': `${BASE_PATH}views/users-view.html`,
                'reports': `${BASE_PATH}views/reports-view.html`,
                'settings': `${BASE_PATH}views/settings-view.html`
            }
        };

        // Funci√≥n para corregir rutas en el HTML cargado
        function fixResourcePaths(html, basePath) {
            return html
                .replace(/src="assets\//g, `src="${basePath}assets/`)
                .replace(/href="assets\//g, `href="${basePath}assets/`)
                .replace(/src="\.\.\/assets\//g, `src="${basePath}assets/`)
                .replace(/href="\.\.\/assets\//g, `href="${basePath}assets/`);
        }

        // Funci√≥n para cargar un archivo HTML
        async function loadHTML(url, containerId) {
            try {
                console.log('üì• Loading:', url);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                let html = await response.text();
                
                // Corregir rutas de recursos si no es el archivo principal
                if (containerId !== 'views-container') {
                    html = fixResourcePaths(html, BASE_PATH);
                }
                
                document.getElementById(containerId).innerHTML = html;
                console.log('‚úÖ Successfully loaded:', url);
                return true;
            } catch (error) {
                console.error('‚ùå Failed to load:', url, error);
                document.getElementById(containerId).innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                        <strong>Error cargando:</strong> ${url}<br>
                        <small>${error.message}</small>
                    </div>
                `;
                return false;
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Inicializar dash.js despu√©s de cargar vistas
        async function initializeDashJS() {
            console.log('üöÄ Initializing dash.js functionality...');
            
            try {
                // Verificar si las funciones de dash.js est√°n disponibles
                if (typeof window.initializeDashboard === 'function') {
                    console.log('‚úÖ dash.js functions are available');
                    
                    // Inicializar componentes espec√≠ficos seg√∫n la vista actual
                    switch(appState.currentView) {
                        case 'dashboard':
                            if (window.initializeDashboard) {
                                window.initializeDashboard();
                            }
                            break;
                        case 'practices':
                            if (window.initializePracticesTable) {
                                window.initializePracticesTable();
                            }
                            break;
                        case 'agenda':
                            if (window.generateAgendaSchedule) {
                                window.generateAgendaSchedule();
                            }
                            break;
                        case 'users':
                            if (window.initializeUsersTable) {
                                window.initializeUsersTable();
                            }
                            break;
                        case 'reports':
                            if (window.initializeReportsTable) {
                                window.initializeReportsTable();
                            }
                            break;
                        case 'settings':
                            // Configuraci√≥n se inicializa autom√°ticamente
                            break;
                    }
                    
                    // ‚úÖ CONECTAR EVENT LISTENERS ESPEC√çFICOS DE DASH.JS
                    reconnectDashListeners();
                    
                } else {
                    console.warn('‚ùå dash.js functions not available yet');
                    // Reintentar en 500ms
                    setTimeout(initializeDashJS, 500);
                }
            } catch (error) {
                console.error('Error initializing dash.js:', error);
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Reconectar listeners espec√≠ficos de dash.js
        function reconnectDashListeners() {
            console.log('üîó Reconnecting dash.js listeners...');
            
            try {
                // Botones de pr√°cticas
                const addPracticeBtn = document.getElementById('add-practice-btn');
                const addPracticeAgendaBtn = document.getElementById('add-practice-agenda-btn');
                
                if (addPracticeBtn) {
                    addPracticeBtn.onclick = function() {
                        if (window.openNewPracticeModal) {
                            window.openNewPracticeModal();
                        }
                    };
                }
                
                if (addPracticeAgendaBtn) {
                    addPracticeAgendaBtn.onclick = function() {
                        if (window.openNewPracticeModal) {
                            window.openNewPracticeModal();
                        }
                    };
                }
                
                // Botones de usuarios
                const addUserBtn = document.getElementById('add-user-btn');
                if (addUserBtn) {
                    addUserBtn.onclick = function() {
                        if (window.openNewUserModal) {
                            window.openNewUserModal();
                        }
                    };
                }
                
                // Botones de exportaci√≥n
                const exportPdfBtn = document.getElementById('export-pdf-btn');
                const exportReportsBtn = document.getElementById('export-reports-btn');
                
                if (exportPdfBtn) {
                    exportPdfBtn.onclick = function() {
                        if (window.showSuccessMessage) {
                            window.showSuccessMessage('Funci√≥n no disponible');
                        }
                    };
                }
                
                if (exportReportsBtn) {
                    exportReportsBtn.onclick = function() {
                        if (window.showSuccessMessage) {
                            window.showSuccessMessage('Funci√≥n no disponible');
                        }
                    };
                }
                
                // Botones de filtros
                const resetFiltersBtn = document.getElementById('reset-filters');
                if (resetFiltersBtn) {
                    resetFiltersBtn.onclick = function() {
                        if (window.resetFilters) {
                            window.resetFilters();
                        }
                    };
                }
                
                console.log('‚úÖ dash.js listeners reconnected');
            } catch (error) {
                console.error('Error reconnecting dash.js listeners:', error);
            }
        }

        // Cargar las secciones al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Initializing application...');
                
                // Cargar secciones principales
                const sections = [
                    { file: `${BASE_PATH}views/header.html`, container: 'header-container' },
                    { file: `${BASE_PATH}views/sidebar-mobile.html`, container: 'mobile-sidebar-container' },
                    { file: `${BASE_PATH}views/sidebar-desktop.html`, container: 'desktop-sidebar-container' },
                    { file: `${BASE_PATH}views/modals.html`, container: 'modals-container' }
                ];

                const loadPromises = sections.map(section => 
                    loadHTML(section.file, section.container)
                );

                await Promise.allSettled(loadPromises);
                
                // Cargar vista inicial
                await showView('dashboard-view');
                initializeEventListeners();

                console.log('üéâ Application initialized successfully');

            } catch (error) {
                console.error('üí• Error initializing application:', error);
                document.getElementById('views-container').innerHTML = `
                    <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                        <h2 class="text-lg font-bold">Error de Inicializaci√≥n</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-primary text-white rounded hover:bg-green-700">
                            Recargar P√°gina
                        </button>
                    </div>
                `;
            }
        });

        // Funci√≥n para cargar vistas - MEJORADA
        async function loadView(viewName) {
            try {
                const viewFile = appState.views[viewName];
                if (!viewFile) {
                    throw new Error(`Vista no encontrada: ${viewName}`);
                }

                console.log('üîÑ Loading view:', viewName);
                
                const success = await loadHTML(viewFile, 'views-container');
                
                if (success) {
                    // Remover cualquier clase hidden que pueda tener el contenido cargado
                    const viewsContainer = document.getElementById('views-container');
                    const loadedView = viewsContainer.querySelector(`#${viewName}-view`);
                    
                    if (loadedView) {
                        loadedView.classList.remove('hidden');
                        loadedView.classList.add('fade-in');
                    } else {
                        // Si no encuentra por ID, remover hidden del primer div dentro del container
                        const firstDiv = viewsContainer.querySelector('div');
                        if (firstDiv) {
                            firstDiv.classList.remove('hidden');
                            firstDiv.classList.add('fade-in');
                        }
                    }
                    
                    appState.currentView = viewName;
                    updateActiveSidebarLink(viewName);
                    
                    // ‚úÖ INICIALIZAR DASH.JS DESPU√âS DE CARGAR LA VISTA
                    setTimeout(() => {
                        initializeDashJS();
                    }, 300);
                    
                    // Reconectar event listeners despu√©s de cargar nueva vista
                    reconnectNavigationListeners();
                }
                
            } catch (error) {
                console.error('Error loading view:', error);
                document.getElementById('views-container').innerHTML = `
                    <div class="p-6 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg fade-in">
                        <h2 class="text-lg font-bold">Vista no disponible</h2>
                        <p>No se pudo cargar: ${viewName}</p>
                        <div class="mt-3 space-x-2">
                            <button onclick="showView('dashboard-view')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-700">
                                Ir al Dashboard
                            </button>
                            <button onclick="location.reload()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Recargar
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Funci√≥n para mostrar vistas
        function showView(viewId) {
            const viewName = viewId.replace('-view', '');
            return loadView(viewName);
        }

        function updateActiveSidebarLink(activeView) {
            setTimeout(() => {
                const allLinks = document.querySelectorAll('[id$="-link"]');
                
                allLinks.forEach(link => {
                    link.classList.remove('bg-primary', 'text-white');
                    link.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                });
                
                const activeLinks = document.querySelectorAll(`#${activeView}-link, #mobile-${activeView}-link`);
                activeLinks.forEach(link => {
                    if (link) {
                        link.classList.add('bg-primary', 'text-white');
                        link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    }
                });
            }, 100);
        }

        // NUEVA FUNCI√ìN: Reconectar listeners de navegaci√≥n
        function reconnectNavigationListeners() {
            console.log('üîÑ Reconnecting navigation listeners...');
            
            // Seleccionar todos los links de navegaci√≥n
            const navLinks = document.querySelectorAll(`
                #dashboard-link, #practices-link, #agenda-link, #users-link, #reports-link, #settings-link,
                #mobile-dashboard-link, #mobile-practices-link, #mobile-agenda-link, #mobile-users-link, 
                #mobile-reports-link, #mobile-settings-link
            `);
            
            navLinks.forEach(link => {
                // Remover event listeners anteriores
                link.replaceWith(link.cloneNode(true));
            });
            
            console.log('‚úÖ Navigation listeners reconnected');
        }

        // FUNCI√ìN initializeEventListeners MODIFICADA
        function initializeEventListeners() {
            console.log('üîó Initializing event listeners...');
            
            // Usar delegaci√≥n de eventos en el documento para manejar la navegaci√≥n
            document.addEventListener('click', function(e) {
                const target = e.target.closest('a');
                if (!target) return;
                
                // Mapeo de navegaci√≥n
                const navMap = {
                    'dashboard-link': 'dashboard',
                    'practices-link': 'practices',
                    'agenda-link': 'agenda', 
                    'users-link': 'users',
                    'reports-link': 'reports',
                    'settings-link': 'settings',
                    'mobile-dashboard-link': 'dashboard',
                    'mobile-practices-link': 'practices',
                    'mobile-agenda-link': 'agenda',
                    'mobile-users-link': 'users',
                    'mobile-reports-link': 'reports',
                    'mobile-settings-link': 'settings'
                };
                
                const viewName = navMap[target.id];
                if (viewName) {
                    e.preventDefault();
                    console.log('üìç Navigation to:', viewName);
                    showView(`${viewName}-view`);
                    
                    // Cerrar men√∫ m√≥vil si est√° abierto
                    closeMobileMenu();
                }
            });
            
            // Listeners para el header (estos no cambian)
            document.addEventListener('click', function(e) {
                // Hamburger menu
                if (e.target.matches('#hamburger-menu') || e.target.closest('#hamburger-menu')) {
                    e.stopPropagation();
                    const mobileMenu = document.getElementById('mobile-menu');
                    if (mobileMenu) {
                        mobileMenu.classList.toggle('active');
                    }
                }
                
                // Cerrar men√∫ al hacer clic fuera
                if (!e.target.closest('#mobile-menu') && !e.target.closest('#hamburger-menu')) {
                    const mobileMenu = document.getElementById('mobile-menu');
                    if (mobileMenu) {
                        mobileMenu.classList.remove('active');
                    }
                }
                
                // User initials click
                if (e.target.matches('#user-initials-btn') || e.target.closest('#user-initials-btn')) {
                    e.stopPropagation();
                    abrirModalCerrarSesion();
                }
            });
            
            console.log('‚úÖ Event listeners initialized');
        }

        // Funciones globales para compatibilidad
        window.showView = showView;
        window.loadView = loadView;
        window.closeMobileMenu = function() {
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu) {
                mobileMenu.classList.remove('active');
            }
        };
        window.abrirModalCerrarSesion = function() {
            const logoutModal = document.getElementById('logout-modal');
            if (logoutModal) {
                logoutModal.classList.remove('hidden');
            }
        };

        // Tailwind config
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#9BD86B",
                        "secondary": "#10b981",
                        "background-light": "#f6f7f8",
                        "background-dark": "#111721",
                        "new-practice": "#9BD86B"
                    },
                    fontFamily: {
                        "display": ["Public Sans"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</body>
</html>